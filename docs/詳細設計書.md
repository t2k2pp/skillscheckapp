# 詳細設計書 - スキルチェッカーアプリケーション (改訂版)

## 1. 概要

本ドキュメントは、「基本設計書」に基づき、「スキルチェッカーアプリケーション」の各モジュールに関する詳細な仕様を定義する。この改訂版では、コンポーネントの仕様、状態遷移、データフローのシーケンスを大幅に詳細化し、第三者がアプリケーションを再現可能にすることを目的とする。

## 2. `App.tsx` - 中枢コンポーネント詳細

### 2.1. 責務
アプリケーション全体の「状態管理ハブ」および「画面ルーター」としての役割を担う。すべてのユーザー操作とデータフローは、このコンポーネントが管理するstateを通じて処理される。

### 2.2. 状態変数 (State) 詳細

| 変数名                | 型                          | 説明                                                     |
|-----------------------|-----------------------------|----------------------------------------------------------|
| `quizState`           | `AppState` (文字列リテラル) | 現在表示すべき画面（状態）を示す。詳細は状態遷移図を参照。 |
| `selectedBook`        | `string | null`             | ユーザーが選択したコンテンツのID (`index.json`内の`id`)。 |
| `currentQuestionSet`  | `QuestionSet | null`        | ロードされた問題セットの全データ (`<id>.json`の内容)。   |
| `currentBookMetadata` | `QuestionSetMetadata | null`| 現在のコンテンツのメタデータ (`index.json`内の要素)。    |
| `selectedCategory`    | `LearningCategory | null`    | ユーザーが選択した学習カテゴリ（クイズ or 辞書）。        |
| `selectedQuizMode`    | `QuizModeType | null`      | ユーザーが選択したクイズモード。                         |
| `currentQuestionIndex`| `number`                    | `questions`配列内の現在の問題インデックス。              |
| `userAnswers`         | `UserAnswer[]`              | ユーザーの解答履歴。                                     |
| `questions`           | `QuizQuestion[]`            | 現在のクイズセッションで出題される問題のリスト。         |
| `startTime`           | `number | null`             | クイズ開始時刻のタイムスタンプ（ミリ秒）。               |
| `questionStartTime`   | `number`                    | 現在の問題の表示開始時刻のタイムスタンプ（ミリ秒）。     |
| `totalTime`           | `number`                    | クイズの総解答時間（ミリ秒）。                           |

### 2.3. 状態遷移図 (`quizState`)

```mermaid
graph TD
    A[book_selection] -->|Select Content| B(category_selection)
    A -->|Select Ebook| I(ebook_viewer)
    A -->|Select PDF| J(pdf_viewer)
    A -->|Select Video| K(video_viewer)

    B -->|Select Quiz| C(quiz_mode_selection)
    B -->|Select Dictionary| G(dictionary_list)
    B -->|Back| A

    C -->|Select AllQuestions| E(active)
    C -->|Select OneByOne/Standard| D(pattern_selection)
    C -->|Back| B

    D -->|Select Pattern| E
    D -->|Select Pattern (OneByOne)| F(one_by_one_active)
    D -->|Back| C

    E -->|Answer| E
    E -->|Last Answer / Finish| H(finished)

    F -->|Next| F
    F -->|Finish / Back| B

    G -->|Select Question| L(dictionary_detail)
    G -->|Back| B

    L -->|Next / Prev| L
    L -->|Back| G

    H -->|Restart| B
    H -->|Back to Books| A

    I -->|Back| A
    J -->|Back| A
    K -->|Back| A
```

### 2.4. 主要ハンドラ関数の処理シーケンス

- **`handleBookSelect(bookId, metadata)`**
  1.  引数 `metadata` の `type` を確認する。
  2.  `type` が `ebook`, `pdf`, `video` の場合:
      - `setSelectedBook`, `setCurrentBookMetadata` でstateを更新。
      - `setQuizState` を対応するビューア (`ebook_viewer`など) に設定し、処理を終了。
  3.  `type` が `quiz` (または未定義) の場合:
      - `QuestionLoader.loadQuestionSet(bookId)` を `await` で呼び出し、問題セットデータを取得。
      - `setSelectedBook`, `setCurrentQuestionSet`, `setCurrentBookMetadata` でstateを更新。
      - `setQuizState` を `category_selection` に設定。

- **`handlePatternSelect(pattern)`**
  1.  `selectedQuizMode` stateを確認。`null`なら処理を中断。
  2.  `prepareQuizQuestions(pattern, ...)` を呼び出し、出題する問題の配列を生成。
  3.  `setQuestions` で問題リストをstateに保存。
  4.  `setCurrentQuestionIndex(0)`, `setUserAnswers([])` でクイズ状態をリセット。
  5.  `selectedQuizMode` に応じて、`setQuizState` を `active` または `one_by_one_active` に設定。
  6.  `active` の場合は `setStartTime`, `setQuestionStartTime` でタイマーを開始。

- **`handleAnswer(answerIndex)`**
  1.  `Date.now()` と `questionStartTime` stateから、現在の問題の解答時間を計算。
  2.  `{ answerIndex, timeTaken }` オブジェクトを生成。
  3.  `setUserAnswers` で解答履歴の末尾に上記オブジェクトを追加。
  4.  `currentQuestionIndex` が最後の問題でない場合:
      - `setCurrentQuestionIndex` でインデックスをインクリメント。
      - `setQuestionStartTime` で次の問題の開始時刻を記録。
  5.  最後の問題だった場合:
      - `setQuizState` を `finished` に設定。
      - `setTotalTime` で総解答時間を計算・保存。

## 3. 全画面コンポーネント詳細仕様

| コンポーネント名                  | 役割と責務                                                                 |
|-----------------------------------|----------------------------------------------------------------------------|
| `BookSelectionScreen.tsx`         | 初期画面。全コンテンツを一覧表示し、選択されたコンテンツ情報を `onSelectBook` Prop経由で `App.tsx` に通知する。 |
| `LearningCategoryScreen.tsx`      | コンテンツの利用方法（クイズ／辞書）を選択させ、結果を `onCategorySelect` Prop経由で通知する。 |
| `QuizModeSelectionScreen.tsx`     | クイズのモード（1問1答／スタンダード／全問）を選択させ、結果を `onModeSelect` Prop経由で通知する。 |
| `PatternSelectionScreen.tsx`      | スタンダードモードの出題パターン（レベル別など）を選択させ、結果を `onPatternSelect` Prop経由で通知する。 |
| `QuestionCard.tsx`                | スタンダード／全問モードで、1問分の問題・選択肢を表示し、解答を `onAnswer` Prop経由で通知する。 |
| `OneByOneQuestionCard.tsx`        | 1問1答モードで、1問分の表示、正誤判定、解説表示を行う。画面遷移は `onNext`, `onFinish` で通知。 |
| `ResultsScreen.tsx`               | クイズ結果（正答率、時間、解答一覧）を表示する。                                           |
| `DictionaryScreen.tsx`            | 辞書モードで、全問題のリストを表示し、選択された問題を `onQuestionSelect` Prop経由で通知する。 |
| `DictionaryDetailCard.tsx`        | 辞書モードで、選択された1問の詳細（問題、選択肢、正解、解説）を表示する。                   |
| `EbookViewer.tsx`                 | Markdown形式のEbookコンテンツを表示する。                                                  |
| `PDFViewer.tsx`                   | PDFコンテンツを表示する。                                                                  |
| `VideoViewer.tsx`                 | YouTubeビデオコンテンツを表示する。                                                        |

## 4. データ構造定義

(変更なし。前バージョンを参照)